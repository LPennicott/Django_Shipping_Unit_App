
{% extends 'base.html' %}
{% load static %}

{% block title %}Record List{% endblock title %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Available Records</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal" data-url="{% url 'records:record_new' %}">
      Add New Record
    </button>

</div>

<p>
    <strong>Total:</strong> {{ total_records }} |
    <strong>Active:</strong> {{ active_count }} |
    <strong>Competitive:</strong> {{ competitive_count }}
</p>

<div class="row">
    {% for record in records %}
    <div class="col-md-6 col-lg-4 mb-4" id="record-card-{{ record.id }}">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">{{ record.name }}</h5>
                <h6 class="card-subtitle mb-2 text-muted">{{ record.email }}</h6>
                <p class="card-text">
                    <strong>Phone:</strong> {{ record.phone }}<br>
                    <strong>Age:</strong> {{ record.age }}<br>
                    <strong>Level:</strong> {{ record.level }}<br>
                    <strong>Active:</strong> {{ record.active|yesno:"Yes,No" }}<br>
                    <strong>Competitive:</strong> {{ record.competitive|yesno:"Yes,No" }}
                </p>
                <button class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#detailModal"
                        data-url="{% url 'records:record_detail' record.pk %}">
                  View Details
                </button>

                <button class="btn btn-secondary btn-sm" data-bs-toggle="modal"
                        data-bs-target="#editModal"
                        data-record-id="{{ record.id }}"
                        data-record-name="{{ record.name }}"
                        data-url="{% url 'records:record_edit' record.id %}">
                    Edit
                </button>
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                        data-record-id="{{ record.id }}"
                        data-record-name="{{ record.name }}"
                        data-url="{% url 'records:record_delete' record.id %}">
                    Delete
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <p>No records found.</p>
    {% endfor %}
</div>

<!-- Add Record Modal -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="addModalContent">
      <!-- AJAX-loaded content goes here -->
    </div>
  </div>
</div>


<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete <strong id="recordName"></strong>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Record</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="editModalBody">
        <!-- Form will be loaded here via AJAX -->
      </div>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="detailModalContent">
      <!-- Content filled by AJAX -->
    </div>
  </div>
</div>

{% endblock content %}

{% block javascript %}

<script>
// View Record
document.addEventListener('DOMContentLoaded', function () {
    const deleteModal = document.getElementById('deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    const recordNameElem = document.getElementById('recordName');
    let deleteUrl = null;

    deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const recordId = button.getAttribute('data-record-id');
        const recordName = button.getAttribute('data-record-name');
        deleteUrl = button.getAttribute('data-url');

        recordNameElem.textContent = recordName;
        deleteForm.setAttribute('data-record-id', recordId);
    });
// Delete Record
    deleteForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
            const response = await fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (data.success) {
                const modal = bootstrap.Modal.getInstance(deleteModal);
                modal.hide();

                const card = document.getElementById(`record-card-${data.id}`);
                if (card) card.remove();

                location.reload();
            } else {
                alert("Failed to delete record.");
            }
        } catch (err) {
            console.error("AJAX delete error:", err);
        }
    });
// Edit Record
    const editModal = document.getElementById('editModal');
    const editModalBody = document.getElementById('editModalBody');

    editModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const editUrl = button.getAttribute('data-url');

        fetch(editUrl, {
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.text())
        .then(html => {
            editModalBody.innerHTML = html;

            const form = editModal.querySelector("form");
            if (form) {
                form.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const csrfToken = form.querySelector("[name=csrfmiddlewaretoken]").value;

                    fetch(editUrl, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                            "X-Requested-With": "XMLHttpRequest"
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            bootstrap.Modal.getInstance(editModal).hide();
                            location.reload();
                        } else {
                            editModalBody.innerHTML = data.html;
                        }
                    });
                });
            }
        });
    });

    const detailModal = document.getElementById("detailModal");
    detailModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const url = button.getAttribute("data-url");

        fetch(url, {
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("detailModalContent").innerHTML = data.html;
        });
    });
});
// Add Record
document.addEventListener("DOMContentLoaded", function () {
  const addModal = document.getElementById("addModal");

  addModal.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const url = button.getAttribute("data-url");

    fetch(url, {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById("addModalContent").innerHTML = data.html;
    });
  });
});

</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const addModal = document.getElementById("addModal");

  addModal.addEventListener("show.bs.modal", function (event) {
    const button = event.relatedTarget;
    const url = button.getAttribute("data-url");

    fetch(url, {
      headers: {
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById("addModalContent").innerHTML = data.html;

      // Attach the submit handler after loading form
      const form = document.getElementById("addRecordForm");
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            const modalInstance = bootstrap.Modal.getInstance(addModal);
            modalInstance.hide();

            // Optional: Refresh page or update UI
            location.reload();  // Or update record list without full reload
          } else {
            // Show validation errors
            document.getElementById("addModalContent").innerHTML = data.html;
          }
        } catch (err) {
          console.error("Error submitting add form:", err);
        }
      });
    });
  });
});
</script>

{% endblock javascript %}
